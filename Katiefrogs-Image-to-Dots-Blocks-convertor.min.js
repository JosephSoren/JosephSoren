  'use strict'; function fromimage(options){var textarray=[];var pixels=options.pixels;if(options.arttype){if(options.arttype==1)var fullblock="\u2591\u2580\u2584\u2588";var fuzy=options.fuzzx;var fuzx=256-fuzy;fuzx*=fuzx*fuzx;fuzy*=fuzy*fuzy}else{var braille="";for(var i=0;i<256;i++)braille+=String.fromCharCode(10240+i);var fuzw=256-options.fuzzw;fuzw*=fuzw*fuzw}var width=options.width;var height=options.height;for(var y=0;y<height;y+=4){var text="";if(!options.silent)self.postMessage({job:"updatestatus",options:(y/ height*100|0)+"%"});for(var x=0;x<width;x+=2){var character=[];for(var i=0;i<4;i++){var absolute=((y+i)*width+x)*4;character.push(pixels.data[absolute]*pixels.data[absolute+1]*pixels.data[absolute+2]);character.push(pixels.data[absolute+4]*pixels.data[absolute+5]*pixels.data[absolute+6])}if(options.arttype==1)if(character[0]>=fuzy&&character[0]<=fuzx&&character[1]>=fuzy&&character[1]<=fuzx)text+="\u2592";else text+=fullblock[(character[2]<fuzx)*2+(character[0]<fuzx)*1]+fullblock[(character[3]<fuzx)* 2+(character[1]<fuzx)*1];else if(options.arttype==2){var gray=0;var black=0;var top=0;var left=0;var right=0;var bottom=0;for(var i in character){black=1;if(character[i]>=fuzy){if(character[i]<=fuzx)gray++;black=0}if(i<4)top+=black;else bottom+=black;if(i%2)right+=black;else left+=black}if(top>bottom+2||top&&!bottom)text+="\u2580";else if(bottom>top+2||bottom&&!top)text+="\u2584";else if(left>right+2||left&&!right)text+="\u258c";else if(right>left+2||right&&!left)text+="\u2590";else if(top&&bottom)text+= "\u2588";else if(gray>3)text+="\u2592";else text+="\u2591"}else text+=String.fromCharCode(10240+(fuzw>character[7])*128+(fuzw>character[6])*64+(fuzw>character[5])*32+(fuzw>character[3])*16+(fuzw>character[1])*8+(fuzw>character[4])*4+(fuzw>character[2])*2+(fuzw>character[0]))}textarray.push(text);if(options.arttype==1)y-=2}if(textarray.length){var max=[textarray[0].length,0];if(options.crop){textarray.forEach(function(a){if(a.length){var maxleft=a.replace(/[^\u2800\u2591].*$/,"").length;if(maxleft< max[0])max[0]=maxleft;if(!options.trim){var maxright=a.replace(/[\u2800\u2591]*$/,"").length;if(maxright>max[1])max[1]=maxright}}});if(options.trim)textarray=textarray.map(function(a){return a.slice(max[0]).replace(/[\u2800\u2591]*$/,"")});else textarray=textarray.map(function(a){return a.slice(max[0],max[1])})}}text=textarray.join("\n");if(options.crop)text=text.replace(/^([\u2800\u2591]*\n)*|(\n[\u2800\u2591]*)*$/g,"").replace(/\n*$|^\n*/g,"");if(!options.arttype&&options.silent==1)if(options.blankdot=== true)text=text.replace(/\u2800/g,function(){return"\u2801\u2802\u2804\u2808\u2810\u2820\u2840\u2880"[Math.random()*8|0]});else text=text.replace(/\u2800/g,options.blankdot);self.postMessage({job:"fromimage",options:{text:text,silent:options.silent}})} function drawfill(options){var oldfill=options.cache[options.y][options.x];var width=options.cache[0].length;var height=options.cache.length;var stack=[[options.x,options.y]];for(;stack.length;){var pop=stack.pop();var x=pop[0];var y=pop[1];for(;0<y--&&options.cache[y][x]==oldfill;);var skipleft=0;var skipright=0;for(;++y<height&&options.cache[y][x]==oldfill;){options.cache[y][x]=options.fillcolor;if(x>0)if(options.cache[y][x-1]==oldfill){if(!skipleft){stack.push([x-1,y]);skipleft=1}}else if(skipleft)skipleft= 0;if(x<width-1)if(options.cache[y][x+1]==oldfill){if(!skipright){stack.push([x+1,y]);skipright=1}}else if(skipright)skipright=0}}self.postMessage({job:"drawfill",options:options.cache})}onmessage=function(e){switch(e.data.job){case "fromimage":fromimage(e.data.options);break;case "drawfill":drawfill(e.data.options);break}};//
     
