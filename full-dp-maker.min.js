!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Compressor=t()}(this,function(){"use strict";function e(e,t){var i,a=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,i)),a}function t(t){for(var i=1;i<arguments.length;i++){var a=null!=arguments[i]?arguments[i]:{};i%2?e(Object(a),!0).forEach(function(e){var i,n;i=t,n=a[e],(e=r(e))in i?Object.defineProperty(i,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[e]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function i(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,r(a.key),a)}}function a(){return(a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i,a=arguments[t];for(i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e}).apply(this,arguments)}function r(e){return"symbol"==typeof(e=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);if("object"!=typeof(i=i.call(e,t||"default")))return i;throw TypeError("@@toPrimitive must return a primitive value.")}(e,"string"))?e:String(e)}function n(e){return 0<e&&e<1/0}var o,l,s,d,c,h,u,p,g={exports:{}},m=(o=g,"undefined"!=typeof window&&(s=(l=window).HTMLCanvasElement&&l.HTMLCanvasElement.prototype,c=(d=l.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}())&&l.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),h=l.BlobBuilder||l.WebKitBlobBuilder||l.MozBlobBuilder||l.MSBlobBuilder,u=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,p=(d||h)&&l.atob&&l.ArrayBuffer&&l.Uint8Array&&function(e){var t,i,a,r,n,o=e.match(u);if(!o)throw Error("invalid data URI");for(t=o[2]?o[1]:"text/plain"+(o[3]||";charset=US-ASCII"),i=((n=!!o[4])?atob:decodeURIComponent)(e=e.slice(o[0].length)),o=new ArrayBuffer(i.length),a=new Uint8Array(o),r=0;r<i.length;r+=1)a[r]=i.charCodeAt(r);return d?new Blob([c?a:o],{type:t}):((n=new h).append(o),n.getBlob(t))},l.HTMLCanvasElement&&!s.toBlob&&(s.mozGetAsFile?s.toBlob=function(e,t,i){var a=this;setTimeout(function(){i&&s.toDataURL&&p?e(p(a.toDataURL(t,i))):e(a.mozGetAsFile("blob",t))})}:s.toDataURL&&p&&(s.msToBlob?s.toBlob=function(e,t,i){var a=this;setTimeout(function(){(t&&"image/png"!==t||i)&&s.toDataURL&&p?e(p(a.toDataURL(t,i))):e(a.msToBlob(t))})}:s.toBlob=function(e,t,i){var a=this;setTimeout(function(){e(p(a.toDataURL(t,i)))})})),o.exports?o.exports=p:l.dataURLtoBlob=p),g.exports),f={strict:!0,checkOrientation:!0,retainExif:!1,maxWidth:1/0,maxHeight:1/0,minWidth:0,minHeight:0,width:void 0,height:void 0,resize:"none",quality:.8,mimeType:"auto",convertTypes:["image/png"],convertSize:5e6,beforeDraw:null,drew:null,success:null,error:null},y="undefined"!=typeof window&&void 0!==window.document?window:{},b=Array.prototype.slice;function w(e){return Array.from?Array.from(e):b.call(e)}var $=/^image\/.+$/;function v(e){return $.test(e)}var _=String.fromCharCode,E=y.btoa;function I(e,t){for(var i=[],a=new Uint8Array(e);0<a.length;)i.push(_.apply(null,w(a.subarray(0,8192)))),a=a.subarray(8192);return"data:".concat(t,";base64,").concat(E(i.join("")))}var k=/\.\d*(?:0|9){12}\d*$/;function B(e,t){return t=1<arguments.length&&void 0!==t?t:1e11,k.test(e)?Math.round(e*t)/t:e}function x(e,t){var i,a=e.aspectRatio,r=e.height,e=e.width,t=1<arguments.length&&void 0!==t?t:"none",o=n(e),l=n(r);return o&&l?(i=r*a,("contain"===t||"none"===t)&&e<i||"cover"===t&&i<e?r=e/a:e=r*a):o?r=e/a:l&&(e=r*a),{width:e,height:r}}var L=y.ArrayBuffer,z=y.FileReader,R=y.URL||y.webkitURL,U=/\.\w+$/,C=y.Compressor;return function(){var e,r,o;function l(e,i){if(!(this instanceof l))throw TypeError("Cannot call a class as a function");this.file=e,this.exif=[],this.image=new Image,this.options=t(t({},f),i),this.aborted=!1,this.result=null,this.init()}return e=l,o=[{key:"noConflict",value:function(){return window.Compressor=C,l}},{key:"setDefaults",value:function(e){a(f,e)}}],r=[{key:"init",value:function(){var e,t,i,r,n=this,o=this.file,l=this.options;r=o,"undefined"!=typeof Blob&&(r instanceof Blob||"[object Blob]"===Object.prototype.toString.call(r))?v(e=o.type)?R&&z?(L||(l.checkOrientation=!1,l.retainExif=!1),t=(r="image/jpeg"===e)&&l.checkOrientation,i=r&&l.retainExif,!R||t||i?(r=new z,(this.reader=r).onload=function(r){var r=r.target.result,l={},s=1;t&&1<(s=function e(t){var i,a,r,n,o,l,s,d=new DataView(t);try{if(255===d.getUint8(0)&&216===d.getUint8(1))for(var c=d.byteLength,h=2;h+1<c;){if(255===d.getUint8(h)&&225===d.getUint8(h+1)){a=h;break}h+=1}if(r=a&&(n=a+10,"Exif"===function(e,t,i){var a,r="";for(i+=t,a=t;a<i;a+=1)r+=_(e.getUint8(a));return r}(d,a+4,4))&&((s=18761===(o=d.getUint16(n)))||19789===o)&&42===d.getUint16(n+2,s)&&8<=(l=d.getUint32(n+4,s))?n+l:r){for(var u,p=d.getUint16(r,s),g=0;g<p;g+=1)if(u=r+12*g+2,274===d.getUint16(u,s)){u+=8,i=d.getUint16(u,s),d.setUint16(u,1,s);break}}}catch(m){i=1}return i}(r))&&a(l,function(e){var t=0,i=1,a=1;switch(e){case 2:i=-1;break;case 3:t=-180;break;case 4:a=-1;break;case 5:t=90,a=-1;break;case 6:t=90;break;case 7:t=90,i=-1;break;case 8:t=-90}return{rotate:t,scaleX:i,scaleY:a}}(s)),i&&(n.exif=function(e){for(var t=w(new Uint8Array(e)),i=t.length,a=[],r=0;r+3<i;){var n=t[r],o=t[r+1];if(255===n&&218===o)break;255===n&&216===o?r+=2:(n=r+(256*t[r+2]+t[r+3])+2,o=t.slice(r,n),a.push(o),r=n)}return a.reduce(function(e,t){return 255===t[0]&&225===t[1]?e.concat(t):e},[])}(r)),l.url=t||i?!R||1<s?I(r,e):R.createObjectURL(o):r,n.load(l)},r.onabort=function(){n.fail(Error("Aborted to read the image with FileReader."))},r.onerror=function(){n.fail(Error("Failed to read the image with FileReader."))},r.onloadend=function(){n.reader=null},t||i?r.readAsArrayBuffer(o):r.readAsDataURL(o)):this.load({url:R.createObjectURL(o)})):this.fail(Error("The current browser does not support image compression.")):this.fail(Error("The first argument must be an image File or Blob object.")):this.fail(Error("The first argument must be a File or Blob object."))}},{key:"load",value:function(e){var i=this,a=this.file,r=this.image;r.onload=function(){i.draw(t(t({},e),{},{naturalWidth:r.naturalWidth,naturalHeight:r.naturalHeight}))},r.onabort=function(){i.fail(Error("Aborted to load the image."))},r.onerror=function(){i.fail(Error("Failed to load the image."))},y.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(y.navigator.userAgent)&&(r.crossOrigin="anonymous"),r.alt=a.name,r.src=e.url}},{key:"draw",value:function(e){var t=this,i=e.naturalWidth,a=e.naturalHeight,r=e.rotate,r=void 0===r?0:r,o=e.scaleX,o=void 0===o?1:o,e=e.scaleY,e=void 0===e?1:e,l=this.file,s=this.image,d=this.options,c=document.createElement("canvas"),h=c.getContext("2d"),u=Math.abs(r)%180==90,p=("contain"===d.resize||"cover"===d.resize)&&n(d.width)&&n(d.height),g=Math.max(d.maxWidth,0)||1/0,f=Math.max(d.maxHeight,0)||1/0,y=Math.max(d.minWidth,0)||0,b=Math.max(d.minHeight,0)||0,$=i/a,_=d.width,E=d.height,k=(u&&(g=(k=[f,g])[0],f=k[1],y=(k=[b,y])[0],b=k[1],_=(k=[E,_])[0],E=k[1]),x({aspectRatio:$=p?_/E:$,width:g,height:f},"contain")),k=(g=k.width,f=k.height,x({aspectRatio:$,width:y,height:b},"cover")),k=(y=k.width,b=k.height,E=p?(_=(k=x({aspectRatio:$,width:_,height:E},d.resize)).width,k.height):(_=void 0===(L=(k=x({aspectRatio:$,width:_,height:E})).width)?i:L,void 0===(L=k.height)?a:L),-(_=Math.floor(B(Math.min(Math.max(_,y),g))))/2),L=-(E=Math.floor(B(Math.min(Math.max(E,b),f))))/2,y=_,g=E,b=[],f=(p&&(f=($=x({aspectRatio:$,width:f=i,height:p=a},{contain:"cover",cover:"contain"}[d.resize])).width,p=$.height,b.push((i-f)/2,(a-p)/2,f,p)),b.push(k,L,y,g),u&&(_=($=[E,_])[0],E=$[1]),c.width=_,c.height=E,v(d.mimeType)||(d.mimeType=l.type),"transparent"),R=(l.size>d.convertSize&&0<=d.convertTypes.indexOf(d.mimeType)&&(d.mimeType="image/jpeg"),"image/jpeg"===d.mimeType);h.fillStyle=f=R?"#fff":f,h.fillRect(0,0,_,E),d.beforeDraw&&d.beforeDraw.call(this,h,c),this.aborted||(h.save(),h.translate(_/2,E/2),h.rotate(r*Math.PI/180),h.scale(o,e),h.drawImage.apply(h,[s].concat(b)),h.restore(),d.drew&&d.drew.call(this,h,c),this.aborted)||(p=function(e){var r,n,o;t.aborted||(r=function(e){return t.done({naturalWidth:i,naturalHeight:a,result:e})},e&&R&&d.retainExif&&t.exif&&0<t.exif.length?(n=function(e){var i,a;return r(m(I((i=t.exif,255!==(a=w(new Uint8Array(e)))[2]||224!==a[3]?e:(e=256*a[4]+a[5],i=[255,216].concat(i,a.slice(4+e)),new Uint8Array(i))),d.mimeType)))},e.arrayBuffer?e.arrayBuffer().then(n).catch(function(){t.fail(Error("Failed to read the compressed image with Blob.arrayBuffer()."))}):(o=new z,(t.reader=o).onload=function(e){n((e=e.target).result)},o.onabort=function(){t.fail(Error("Aborted to read the compressed image with FileReader."))},o.onerror=function(){t.fail(Error("Failed to read the compressed image with FileReader."))},o.onloadend=function(){t.reader=null},o.readAsArrayBuffer(e))):r(e))},c.toBlob?c.toBlob(p,d.mimeType,d.quality):p(m(c.toDataURL(d.mimeType,d.quality))))}},{key:"done",value:function(e){var t=e.naturalWidth,i=e.naturalHeight,e=e.result,a=this.file,r=this.image,n=this.options;R&&0===r.src.indexOf("blob:")&&R.revokeObjectURL(r.src),e&&(!n.strict||n.retainExif||!(e.size>a.size)||n.mimeType!==a.type||n.width>t||n.height>i||n.minWidth>t||n.minHeight>i||n.maxWidth<t||n.maxHeight<i)?(r=new Date,e.lastModified=r.getTime(),e.lastModifiedDate=r,e.name=a.name,e.name&&e.type!==a.type&&(e.name=e.name.replace(U,(t=v(t=e.type)?t.substr(6):"",".".concat(t="jpeg"===t?"jpg":t))))):e=a,this.result=e,n.success&&n.success.call(this,e)}},{key:"fail",value:function(e){var t=this.options;if(!t.error)throw e;t.error.call(this,e)}},{key:"abort",value:function(){this.aborted||(this.aborted=!0,this.reader?this.reader.abort():this.image.complete?this.fail(Error("The compression process has been aborted.")):(this.image.onload=null,this.image.onabort()))}}],i(e.prototype,r),o&&i(e,o),Object.defineProperty(e,"prototype",{writable:!1}),l}()}),blur=document.querySelector("#blur"),makeSquareBtn=document.getElementById("make-square"),colorSquareBtn=document.getElementById("color-square"),backgroundColorInput=document.getElementById("background-color"),uploadButton=document.getElementById("upload-button"),previewCanvas=document.createElement("canvas"),downloadCanvas=document.createElement("canvas"),previewCtx=previewCanvas.getContext("2d"),downloadCtx=downloadCanvas.getContext("2d"),imageContainer=document.querySelector(".image-container"),resizeSquareBtn=document.getElementById("resize-square");const cropSquareBtn=document.getElementById("crop-square"),blurOptionDiv=document.getElementById("blur-option"),colorOptionDiv=document.getElementById("color-option");let image=new Image,myImage=null,croppieInstance;const fixedCanvasSize=800;let croppieLoaded=!1;const dropZone=document.getElementById("drop-zone");async function loadJSZip(){return new Promise((e,t)=>{let i=document.createElement("script");i.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",i.onload=()=>e(),i.onerror=()=>t("Failed to load JSZip library"),document.body.appendChild(i)})}function loadCroppie(){return new Promise((e,t)=>{let i=document.createElement("link");i.rel="stylesheet",i.href="https://squareanimage.com/croppie.min.css",document.head.appendChild(i);let a=document.createElement("script");a.src="https://squareanimage.com/croppie.min.js",a.onload=()=>e(),a.onerror=()=>t("Failed to load Croppie library"),document.body.appendChild(a)})}dropZone.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),dropZone.addEventListener("drop",e=>{e.preventDefault(),handleFiles(e.dataTransfer.files)}),cropSquareBtn.addEventListener("change",async()=>{if(cropSquareBtn.checked&&!croppieLoaded)try{await loadCroppie(),croppieLoaded=!0,console.log("Croppie library loaded successfully")}catch(e){console.error("Failed to load Croppie library:",e)}myImage&&myImage.draw()});class CanvasImage{constructor(e,t,i,a){this.type=e,this.width=t,this.height=i,this.size="horizontal"===e?t:i,this.bigWidth="horizontal"===e?t*t/i:i,this.bigHeight="horizontal"===e?t:i*i/t,this.image=a,this.filter=null}changeFilter(e){this.filter=e}async draw(){if(imageContainer.innerHTML="",cropSquareBtn.checked){let e=document.createElement("div");e.setAttribute("id","croppie-container"),imageContainer.appendChild(e),(croppieInstance=new Croppie(e,{viewport:{width:250,height:250},boundary:{width:300,height:300},showZoomer:!0,enableOrientation:!0,Zoom:0})).bind({url:this.image.src,zoom:0}),croppieInstance.setZoom(0)}else if(resizeSquareBtn.checked)[previewCanvas,downloadCanvas].forEach((e,t)=>{let i=e.getContext("2d"),a=0===t?800/this.size:1;i.clearRect(0,0,e.width,e.height),e.width=this.size*a,e.height=this.size*a,i.drawImage(this.image,0,0,e.width,e.height)});else if(colorSquareBtn.checked){let t=backgroundColorInput.value;[previewCanvas,downloadCanvas].forEach((e,i)=>{let a=e.getContext("2d"),r=0===i?800/this.size:1;a.clearRect(0,0,e.width,e.height),e.width=this.size*r,e.height=this.size*r,a.fillStyle=t,a.fillRect(0,0,e.width,e.height),a.drawImage(this.image,(e.width-this.width*r)/2,(e.height-this.height*r)/2,this.width*r,this.height*r)})}else makeSquareBtn.checked&&[previewCanvas,downloadCanvas].forEach((e,t)=>{let i=e.getContext("2d"),a=0===t?800/this.size:1;i.clearRect(0,0,e.width,e.height),e.width=this.size*a,e.height=this.size*a,i.translate(this.size*a/2,this.size*a/2),i.filter=`blur(${blur.value}px)`,i.drawImage(this.image,-(this.bigWidth*a)/2,-(this.bigHeight*a)/2,this.bigWidth*a,this.bigHeight*a),i.filter="none",i.drawImage(this.image,-(this.width*a)/2,-(this.height*a)/2,this.width*a,this.height*a)});imageContainer.appendChild(previewCanvas)}}const download=document.querySelector(".download");download.addEventListener("click",async()=>{if(cropSquareBtn.checked&&croppieInstance)download.disabled=!0,croppieInstance.result({type:"blob",size:"original"}).then(e=>{new Compressor(e,{quality:.9,maxWidth:myImage.width,maxHeight:myImage.height,success(e){let t=document.createElement("a");t.download="Cropped_Image.png",t.href=URL.createObjectURL(e),t.click(),URL.revokeObjectURL(t.href),setTimeout(()=>{download.disabled=!1},500)},error(e){console.log(e.message),setTimeout(()=>{download.disabled=!1},500)}})});else{download.disabled=!0;let e=downloadCanvas.toDataURL("image/png");try{let t=await (await fetch(e)).blob();new Compressor(t,{quality:.9,maxWidth:downloadCanvas.width,maxHeight:downloadCanvas.height,success(e){let t=URL.createObjectURL(e),i=document.createElement("a");i.download="Image_Editor.png",i.href=t,i.click(),URL.revokeObjectURL(t),setTimeout(()=>{download.disabled=!1},500)},error(e){console.log(e.message),setTimeout(()=>{download.disabled=!1},500)}})}catch(i){console.error("Error fetching the image blob:",i),setTimeout(()=>{download.disabled=!1},500)}}}),uploadButton.onchange=()=>{let e=new FileReader;e.readAsDataURL(uploadButton.files[0]),e.onload=()=>{image.src=e.result,image.onload=function(){let e=this.width>this.height?"horizontal":"vertical",t=this.height,i=this.width;download.classList.remove("hidden"),(myImage=new CanvasImage(e,i,t,image)).draw()}}},makeSquareBtn.addEventListener("input",()=>{colorSquareBtn.checked=!1,myImage.draw()}),colorSquareBtn.addEventListener("input",()=>{makeSquareBtn.checked=!1,myImage.draw()}),blur.addEventListener("input",e=>{let t=e.target;"range"!==e.target.type&&(t=document.getElementById("range"));let i=t.min,a=t.max,r=t.value;t.style.backgroundSize=(r-i)*100/(a-i)+"% 100%",image.src&&myImage.draw()}),document.addEventListener("DOMContentLoaded",async()=>{await loadCroppie(),croppieLoaded=!0;let e=document.getElementById("color-square"),t=document.getElementById("color-option");e.addEventListener("change",function(){e.checked?t.style.display="block":t.style.display="none"})}),makeSquareBtn.addEventListener("change",()=>{blurOptionDiv.style.display="block",colorOptionDiv.style.display="none",previewCanvas.style.display="block",myImage&&myImage.draw()}),colorSquareBtn.addEventListener("change",()=>{blurOptionDiv.style.display="none",colorOptionDiv.style.display="block",previewCanvas.style.display="block",myImage&&myImage.draw()}),resizeSquareBtn.addEventListener("change",()=>{blurOptionDiv.style.display="none",colorOptionDiv.style.display="none",myImage&&(previewCanvas.style.display="block",myImage.draw())}),cropSquareBtn.addEventListener("change",()=>{blurOptionDiv.style.display="none",colorOptionDiv.style.display="none",previewCanvas.style.display="none",myImage&&myImage.draw()}),backgroundColorInput.addEventListener("input",()=>{myImage&&myImage.draw()});
